name: CI

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run pytest
        run: pytest -q

  smoke:
    needs: test
    runs-on: ubuntu-latest
    if: ${{ secrets.RAILWAY_WEB_URL != '' }}
    steps:
      - name: Call deployed health endpoint
        env:
          RAILWAY_WEB_URL: ${{ secrets.RAILWAY_WEB_URL }}
          BASIC_AUTH_USERNAME: ${{ secrets.BASIC_AUTH_USERNAME }}
          BASIC_AUTH_PASSWORD: ${{ secrets.BASIC_AUTH_PASSWORD }}
        run: |
          if [ -z "$RAILWAY_WEB_URL" ]; then
            echo "RAILWAY_WEB_URL not set, skipping"
            exit 0
          fi
          if [ -n "$BASIC_AUTH_USERNAME" ] && [ -n "$BASIC_AUTH_PASSWORD" ]; then
            curl -sSf -u "$BASIC_AUTH_USERNAME:$BASIC_AUTH_PASSWORD" "$RAILWAY_WEB_URL/healthz" > /dev/null
          else
            curl -sSf "$RAILWAY_WEB_URL/healthz" > /dev/null
          fi
